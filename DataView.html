<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church & Service Information</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .container-fluid { max-width: 1140px; }
        .section-header { margin-top: 30px; margin-bottom: 15px; }
        table.dataTable th { background-color: #e9ecef; cursor: pointer; } /* Styling for DataTable headers */
        .table-responsive { margin-top: 20px; }
        #statusMessage { margin-top: 15px; }
        .modal-body { max-height: 70vh; overflow-y: auto; }
        .modal-body ul { padding-left: 20px; list-style-type: none; }
        .modal-body li { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        .modal-body li:last-child { border-bottom: none; }
        .modal-body h5 { margin-top: 15px; }
        /* Styling for DataTables controls to match Bootstrap better */
        div.dataTables_wrapper div.dataTables_filter input,
        div.dataTables_wrapper div.dataTables_length select {
            margin-left: 0.5em; display: inline-block; width: auto;
            padding: .375rem .75rem; font-size: 0.875rem; /* Smaller font for controls */
            font-weight: 400; line-height: 1.5; color: #495057;
            background-color: #fff; background-clip: padding-box;
            border: 1px solid #ced4da; border-radius: .25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .view-services-btn { white-space: nowrap; } /* Prevent button text from wrapping */
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="my-4 text-center">
            <h1>Church Information & Regular Services</h1>
            <p><a href="index.html">Back to Main Calendar</a></p> </header>

        <div id="statusMessage" style="display: none;"></div>

        <div class="table-responsive">
            <table id="churchesInfoTable" class="table table-striped table-bordered table-hover table-sm" style="width:100%;">
                <thead class="thead-dark">
                    <tr>
                        <th>Church Name</th>
                        <th>Lead Minister</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="churchesTableBody">
                    <tr><td colspan="5" class="text-center">Loading church data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="servicesModal" tabindex="-1" role="dialog" aria-labelledby="servicesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="servicesModalLabel">Regular Services</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="servicesModalBody">
                    <p>Loading services...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>

    <script>
        // URL of your deployed Google Apps Script web app (the one serving data for your calendar)
        const SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbz0svFL0DvyXVMc3ebkKaEyFwVSl3zWe1ff0qO5NQ1J66AlO8YSwYERGqxsZbDhR1K75g/exec'; // Replace with YOUR actual API URL

        let allChurchesData = [];
        let allMinistersData = [];
        let allServicesData = [];
        let churchesDataTable; // To hold the DataTable instance

        function displayStatus(message, isError = false, autoClear = true) {
            const statusMsg = document.getElementById("statusMessage");
            if (!statusMsg) return;
            statusMsg.textContent = message;
            statusMsg.className = isError ? "alert alert-danger mt-3" : "alert alert-info mt-3";
            statusMsg.style.display = 'block';

            if (!isError && autoClear && message !== "Loading data...") {
                setTimeout(() => {
                    if (statusMsg.textContent === message) {
                        statusMsg.textContent = "";
                        statusMsg.className = "";
                        statusMsg.style.display = 'none';
                    }
                }, 5000);
            }
        }

        async function fetchSheetDataForStaticPage(sheetName) {
            try {
                const response = await fetch(`${SCRIPT_API_URL}?sheet=${sheetName}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} for ${sheetName}`);
                }
                const result = await response.json();
                if (result.error) {
                    throw new Error(`API error for ${sheetName}: ${result.error}`);
                }
                return result.data || [];
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                displayStatus(`Failed to load ${sheetName}: ${error.message}`, true, false);
                return [];
            }
        }

        function initializeDataTable(tableId) {
            if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                // Get existing instance, clear it, and re-add data if needed (not done here, assumes full repopulate)
                // For simplicity, if re-populating, ensure table is cleared before DataTable re-init,
                // or destroy and re-create. The current populateChurchesTable destroys first.
            }
             // Ensure table is empty before re-initializing if it was already a DataTable
            if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                 $(`#${tableId}`).DataTable().destroy();
                 $(`#${tableId} tbody`).empty(); // Clear tbody content before repopulating for DataTable
            }

            churchesDataTable = $(`#${tableId}`).DataTable({
                "pageLength": 25, // Default number of rows per page
                "lengthMenu": [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "All"] ],
                "destroy": true // Ensures clean re-initialization if called again
            });
        }

        function populateChurchesTable() {
            const tbody = document.getElementById("churchesTableBody");
            if (!tbody) {
                console.error("populateChurchesTable: churchesTableBody element not found!");
                return;
            }

            if ($.fn.DataTable.isDataTable('#churchesInfoTable')) {
                $('#churchesInfoTable').DataTable().destroy();
            }
            tbody.innerHTML = ""; // Clear existing rows or "Loading..." message

            if (allChurchesData && allChurchesData.length > 0) {
                allChurchesData.forEach(church => {
                    if (!church) return; // Skip if church object is null or undefined
                    const row = tbody.insertRow();
                    
                    row.insertCell().textContent = church.ChurchName || "N/A";

                    let ministerName = "N/A";
                    // Prioritize MinisterID if it exists, then LeadMinisterID as fallback
                    let ministerIdToFind = church.MinisterID || church.LeadMinisterID; 
                    if (ministerIdToFind && allMinistersData && allMinistersData.length > 0) {
                        const minister = allMinistersData.find(
                            m => m && String(m.MinisterID).trim() === String(ministerIdToFind).trim()
                        );
                        if (minister) {
                            ministerName = minister.Name || "N/A"; // Ensure minister.Name exists
                        }
                    }
                    row.insertCell().textContent = ministerName;
                    row.insertCell().textContent = church.Address || "N/A";
                    
                    const actionsCell = row.insertCell();
                    const churchNameAttr = church.ChurchName ? church.ChurchName.replace(/"/g, '&quot;') : 'Selected Church';
                    actionsCell.innerHTML = `<button type="button" class="btn btn-sm btn-info view-services-btn" data-churchid="${church.ChurchID || ''}" data-churchname="${churchNameAttr}">View Services</button>`;
                });
                initializeDataTable('churchesInfoTable'); // Initialize after tbody is fully populated
                attachServiceButtonListeners();
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No churches found.</td></tr>';
            }
        }

        function attachServiceButtonListeners() {
            $('#churchesInfoTable tbody').off('click', 'button.view-services-btn').on('click', 'button.view-services-btn', function () {
                const churchId = $(this).data('churchid');
                const churchName = $(this).data('churchname');
                if (churchId) {
                    displayServicesInModal(String(churchId), churchName);
                } else {
                    console.error("View Services button clicked without a churchId.");
                }
            });
        }

        function displayServicesInModal(churchId, churchName) {
            const modalTitle = document.getElementById("servicesModalLabel");
            const modalBody = document.getElementById("servicesModalBody");

            if(!modalTitle || !modalBody){ console.error("Modal elements not found!"); return; }

            modalTitle.textContent = `Regular Services for ${churchName}`;
            modalBody.innerHTML = '<p>Loading services...</p>';

            const servicesForChurch = allServicesData.filter(
                service => service && String(service.ChurchID).trim() === churchId.trim()
            );

            if (servicesForChurch.length > 0) {
                const servicesByDay = {};
                servicesForChurch.forEach(s => {
                    if (!s.ServiceDay) return; // Skip if ServiceDay is missing
                    if (!servicesByDay[s.ServiceDay]) servicesByDay[s.ServiceDay] = [];
                    servicesByDay[s.ServiceDay].push(s);
                });

                let servicesHtml = "";
                const dayOrder = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                
                dayOrder.forEach(dayKey => {
                    if (servicesByDay[dayKey] && servicesByDay[dayKey].length > 0) {
                        servicesHtml += `<h5>${dayKey}</h5><ul>`;
                        servicesByDay[dayKey].sort((a, b) => { 
                            return (parseSimpleTimeForSort(a.ServiceTime) || 0) - (parseSimpleTimeForSort(b.ServiceTime) || 0);
                        }).forEach(service => {
                            servicesHtml += `<li><strong>${service.ServiceTime || 'N/A'}:</strong> ${service.ServiceType || 'N/A'}</li>`;
                        });
                        servicesHtml += "</ul>";
                    }
                });

                if (servicesHtml === "") { // Fallback if no services matched ordered days (e.g. different day names)
                    servicesHtml = "<ul>";
                     servicesForChurch.forEach(service => {
                        servicesHtml += `<li><strong>${service.ServiceDay || 'N/A'} at ${service.ServiceTime || 'N/A'}:</strong> ${service.ServiceType || 'N/A'}</li>`;
                    });
                    servicesHtml += "</ul>";
                }
                modalBody.innerHTML = servicesHtml;
            } else {
                modalBody.innerHTML = "<p>No regular services listed for this church.</p>";
            }
            $('#servicesModal').modal('show');
        }
        
        function parseSimpleTimeForSort(timeStr) { // Helper for sorting times
            if (!timeStr || typeof timeStr !== 'string') return null;
            const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)?/i);
            if (!match) return null;
            let hours = parseInt(match[1], 10);
            const minutes = parseInt(match[2], 10);
            const modifier = match[3] ? match[3].toUpperCase() : null;
            if (modifier === "PM" && hours < 12) hours += 12;
            if (modifier === "AM" && hours === 12) hours = 0; // Midnight
            return hours * 60 + minutes; // Total minutes from midnight
        }

        async function loadInitialData() {
            displayStatus("Loading data...", false, false); 
            try {
                const [churches, ministers, services] = await Promise.all([
                    fetchSheetDataForStaticPage("Churches"),
                    fetchSheetDataForStaticPage("Ministers"),
                    fetchSheetDataForStaticPage("Services") 
                ]);

                allChurchesData = churches || []; // Ensure they are arrays
                allMinistersData = ministers || [];
                allServicesData = services || [];

                populateChurchesTable();
                displayStatus("Data loaded successfully!", false, true); // Auto-clear success
            } catch (err) {
                // Error is already displayed by fetchSheetDataForStaticPage
                console.error("General error during loadInitialData (Promise.all):", err);
                 displayStatus("A general error occurred while loading data.", true, false); // Persistent general error
            }
        }

        window.onload = function() {
            if(typeof $ !== 'undefined' && $.fn.DataTable) {
                loadInitialData();
            } else {
                console.error("jQuery or DataTables not loaded. Check script tags in index.html.");
                const statusMsg = document.getElementById("statusMessage");
                if (statusMsg) {
                    statusMsg.textContent = "Error: Page components (jQuery/DataTables) not loaded.";
                    statusMsg.className = "alert alert-danger mt-3";
                    statusMsg.style.display = 'block';
                }
            }
        };
    </script>
</body>
</html>