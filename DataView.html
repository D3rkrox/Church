<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church & Service Information with Map</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .container-fluid { max-width: 1140px; }
        .section-header { margin-top: 30px; margin-bottom: 15px; }
        table.dataTable th { background-color: #e9ecef; cursor: pointer; }
        .table-responsive { margin-top: 20px; }
        #statusMessage { margin-top: 15px; }
        .modal-body ul { padding-left: 20px; list-style-type: none; }
        .modal-body li { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        .modal-body li:last-child { border-bottom: none; }
        .modal-body h5 { margin-top: 15px; }
        div.dataTables_wrapper div.dataTables_filter input,
        div.dataTables_wrapper div.dataTables_length select {
            margin-left: 0.5em; display: inline-block; width: auto;
            padding: .375rem .75rem; font-size: 0.875rem;
            font-weight: 400; line-height: 1.5; color: #495057;
            background-color: #fff; background-clip: padding-box;
            border: 1px solid #ced4da; border-radius: .25rem;
        }
        .view-services-btn, .show-map-btn { white-space: nowrap; }
        #mapModalLeaflet .modal-dialog { max-width: 90%; } 
        #mapCanvasLeaflet { height: 70vh; width: 100%; border: 1px solid #ccc; } 
        .map-controls { margin-bottom: 15px; text-align: center; }
        div.dataTables_wrapper div.dataTables_length select { /* Styling for "Show X entries" dropdown */
            width: auto; /* Let content determine width initially */
            min-width: 70px; /* Set a minimum width - adjusted to 70px for better look */
            display: inline-block;
            padding: .375rem 1.75rem .375rem .75rem; /* Adjust padding for select arrow and content */
            font-size: 0.875rem; 
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            /* background-image: ... (Bootstrap's default select arrow) ... */ /* This is usually handled by Bootstrap's CSS */
            /* background-repeat: no-repeat; */
            /* background-position: right .75rem center; */
            /* background-size: 16px 12px; */
            border: 1px solid #ced4da;
            border-radius: .25rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="my-4 text-center">
            <h1>Church Information & Regular Services</h1>
            <p><a href="index.html">Back to Main Calendar</a></p> 
        </header>

        <div id="statusMessage" style="display: none;"></div>

        <div class="map-controls">
            <button id="showChurchesMapBtnLeaflet" class="btn btn-info btn-lg show-map-btn">Show All Churches on Map</button>
        </div>

        <div class="table-responsive">
            <table id="churchesInfoTable" class="table table-striped table-bordered table-hover table-sm" style="width:100%;">
                <thead class="thead-dark">
                    <tr>
                        <th>Church Name</th>
                        <th>Lead Minister</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="churchesTableBody">
                    <tr><td colspan="5" class="text-center">Loading church data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="servicesModal" tabindex="-1" role="dialog" aria-labelledby="servicesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="servicesModalLabel">Regular Services</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body" id="servicesModalBody"><p>Loading services...</p></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="mapModalLeaflet" tabindex="-1" role="dialog" aria-labelledby="mapModalLabelLeaflet" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mapModalLabelLeaflet">Church Locations</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body">
                    <div id="mapCanvasLeaflet"></div>
                    <p class="text-muted mt-2"><small>Map tiles by OpenStreetMap. Pin locations based on provided coordinates or geocoded addresses.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close Map</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbz0svFL0DvyXVMc3ebkKaEyFwVSl3zWe1ff0qO5NQ1J66AlO8YSwYERGqxsZbDhR1K75g/exec';

        let allChurchesData = [];
        let allMinistersData = [];
        let allServicesData = [];
        let churchesDataTable; 
        let leafletMap; 
        let leafletMarkers = []; // Keep track of markers to manage them

        function displayStatus(message, isError = false, autoClear = true) {
            const statusMsg = document.getElementById("statusMessage");
            if (!statusMsg) return;
            statusMsg.textContent = message;
            statusMsg.className = isError ? "alert alert-danger mt-3" : "alert alert-info mt-3";
            statusMsg.style.display = 'block';
            if (!isError && autoClear && message !== "Loading data...") {
                setTimeout(() => { 
                    if (statusMsg.textContent === message) {
                        statusMsg.textContent = ""; 
                        statusMsg.className=""; 
                        statusMsg.style.display = 'none';
                    }
                }, 5000);
            }
        }
        async function fetchSheetDataForStaticPage(sheetName) {
            try {
                const response = await fetch(`${SCRIPT_API_URL}?sheet=${sheetName}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} for ${sheetName}`);
                const result = await response.json();
                if (result.error) throw new Error(`API error for ${sheetName}: ${result.error}`);
                // console.log(`Fetched ${sheetName}:`, result.data ? result.data.slice(0,3) : 'No data'); 
                return result.data || [];
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                displayStatus(`Failed to load ${sheetName}: ${error.message}`, true, false);
                return []; 
            }
        }
        function initializeDataTable(tableId) {
            if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
                 $(`#${tableId}`).DataTable().destroy();
                 $(`#${tableId} tbody`).empty(); 
            }
            churchesDataTable = $(`#${tableId}`).DataTable({
                "pageLength": 25,
                "lengthMenu": [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "All"] ],
                "destroy": true 
            });
        }
        function populateChurchesTable() {
            const tbody = document.getElementById("churchesTableBody");
            if (!tbody) { console.error("populateChurchesTable: churchesTableBody element not found!"); return; }

            if ($.fn.DataTable.isDataTable('#churchesInfoTable')) {
                $('#churchesInfoTable').DataTable().destroy();
            }
            tbody.innerHTML = ""; 

            if (allChurchesData && allChurchesData.length > 0) {
                allChurchesData.forEach(church => {
                    if (!church) return; 
                    const row = tbody.insertRow();
                    row.insertCell().textContent = church.ChurchName || "N/A";
                    let ministerName = "N/A";
                    let ministerIdToFind = church.MinisterID || church.LeadMinisterID; 
                    if (ministerIdToFind && allMinistersData && allMinistersData.length > 0) {
                        const minister = allMinistersData.find(m => m && String(m.MinisterID).trim() === String(ministerIdToFind).trim());
                        if (minister) ministerName = minister.Name || "N/A";
                    }
                    row.insertCell().textContent = ministerName;
                    const addressCell = row.insertCell();
                    if (church.Address) { 
                        const encodedAddress = encodeURIComponent(church.Address);
                        addressCell.innerHTML = `<a href="https://maps.google.com/?q=${encodedAddress}" target="_blank">${church.Address}</a>`; // Corrected Google Maps link
                    } else { addressCell.textContent = "N/A"; }
                    
                    const actionsCell = row.insertCell();
                    const churchNameAttr = church.ChurchName ? church.ChurchName.replace(/"/g, '&quot;') : 'Selected Church'; // Sanitize for attribute
                    actionsCell.innerHTML = `<button type="button" class="btn btn-sm btn-info view-services-btn" data-churchid="${church.ChurchID || ''}" data-churchname="${churchNameAttr}">View Services</button>`;
                });
                initializeDataTable('churchesInfoTable'); 
                attachServiceButtonListeners();
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No churches found.</td></tr>';
            }
        }
        function attachServiceButtonListeners() {
            $('#churchesInfoTable tbody').off('click', 'button.view-services-btn').on('click', 'button.view-services-btn', function () {
                const churchId = $(this).data('churchid');
                const churchName = $(this).data('churchname');
                if (churchId) displayServicesInModal(String(churchId), churchName);
                else console.error("View Services button clicked without a churchId.");
            });
        }
        function displayServicesInModal(churchId, churchName) {
            const modalTitle = document.getElementById("servicesModalLabel");
            const modalBody = document.getElementById("servicesModalBody");

            if(!modalTitle || !modalBody){ console.error("Services modal elements not found!"); return; }

            modalTitle.textContent = `Services for ${churchName}`;
            modalBody.innerHTML = '<p>Loading services...</p>'; // Reset body

            const servicesForChurch = allServicesData.filter(
                service => service && String(service.ChurchID).trim() === churchId.trim()
            );

            let regularServicesHtml = "<h6>Weekly Services</h6>";
            let specialServicesHtml = "<h6>Regular Weekend & Communion  Service</h6>";
            let hasRegular = false;
            let hasSpecial = false;

            const regularServicesByDay = {};
            const specialServiceEntries = [];

            if (servicesForChurch.length > 0) {
                servicesForChurch.forEach(s => {
                    if (!s) return;
                    if (String(s.ServiceDay).toLowerCase() === "special") {
                        specialServiceEntries.push(s);
                        hasSpecial = true;
                    } else if (s.ServiceDay) { // Regular day
                        if (!regularServicesByDay[s.ServiceDay]) regularServicesByDay[s.ServiceDay] = [];
                        regularServicesByDay[s.ServiceDay].push(s);
                        hasRegular = true;
                    }
                });

                if (hasRegular) {
                    const dayOrder = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    let tempRegularHtml = "";
                    dayOrder.forEach(dayKey => {
                        if (regularServicesByDay[dayKey] && regularServicesByDay[dayKey].length > 0) {
                            tempRegularHtml += `<h5>${dayKey}</h5><ul>`;
                            regularServicesByDay[dayKey].sort((a,b) => (parseSimpleTimeForSort(a.ServiceTime)||0) - (parseSimpleTimeForSort(b.ServiceTime)||0))
                                .forEach(service => { 
                                    tempRegularHtml += `<li class="service-detail"><strong>${service.ServiceTime||'N/A'}:</strong> ${service.ServiceType||'N/A'}</li>`; 
                                });
                            tempRegularHtml += "</ul>";
                        }
                    });
                    if (tempRegularHtml === "") tempRegularHtml = "<p>No regular weekly services listed.</p>";
                    regularServicesHtml += tempRegularHtml;
                } else {
                    regularServicesHtml += "<p>No regular weekly services listed.</p>";
                }

                if (hasSpecial) {
                    let tempSpecialHtml = "<ul>";
                    // Optionally sort special services, e.g., by rule or type
                    specialServiceEntries.sort((a,b) => (a.RegularMeetingRule || "").localeCompare(b.RegularMeetingRule || "") || (parseSimpleTimeForSort(a.ServiceTime)||0) - (parseSimpleTimeForSort(b.ServiceTime)||0) )
                        .forEach(service => {
                        tempSpecialHtml += `<li class="service-detail">`;
                            if (service.RegularMeetingRule) {
                                tempSpecialHtml += `<strong>${service.ServiceType || 'Special Service'} on ${service.RegularMeetingRule || 'N/A'}</strong>`;
                            }
                            if(service.CommunionNight) {
                                tempSpecialHtml += `<strong>${service.ServiceType || 'Special Service'} on ${service.CommunionNight || 'N/A'}</strong>`;
                            }
                        tempSpecialHtml += `</li>`;
                    });
                    tempSpecialHtml += "</ul>";
                    specialServicesHtml += tempSpecialHtml;
                } else {
                    specialServicesHtml += "<p>No special monthly or other services listed.</p>";
                }

                modalBody.innerHTML = regularServicesHtml + "<hr>" + specialServicesHtml;

            } else {
                modalBody.innerHTML = "<p>No services listed for this church.</p>";
            }
            $('#servicesModal').modal('show');
        }
        function parseSimpleTimeForSort(timeStr) { 
            if (!timeStr || typeof timeStr !== 'string') return null;
            const match = timeStr.match(/(\d+):(\d+)\s*(AM|PM)?/i);
            if (!match) return null;
            let hours = parseInt(match[1], 10);
            const minutes = parseInt(match[2], 10);
            const modifier = match[3] ? match[3].toUpperCase() : null;
            if (modifier === "PM" && hours < 12) hours += 12;
            if (modifier === "AM" && hours === 12) hours = 0;
            return hours * 60 + minutes; 
        }

        async function geocodeAddressWithNominatim(address) {
            const encodedAddress = encodeURIComponent(address);
            const headers = new Headers({ 'User-Agent': 'ChurchDenominationMap/1.0 (ChurchApp@gmail.com)' }); // Replace with your info
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`;
            try {
                const response = await fetch(url, { headers: headers });
                if (!response.ok) throw new Error(`Nominatim HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (data && data.length > 0 && data[0].lat && data[0].lon) { 
                    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                } else {
                    console.warn(`Address not found or no coordinates from Nominatim: ${address}`);
                    return null; 
                }
            } catch (error) {
                console.warn(`Geocoding failed for ${address} with Nominatim:`, error);
                return null; 
            }
        }

        function fitMapToMarkers() {
            if (!leafletMap || leafletMarkers.length === 0) return;

            const featureGroup = L.featureGroup(leafletMarkers);
            const mapBounds = featureGroup.getBounds();

            if (mapBounds.isValid()) {
                console.log("Fitting bounds:", mapBounds.toBBoxString());
                leafletMap.fitBounds(mapBounds.pad(0.1)); // Add some padding

                // If only one marker, or if fitBounds results in a very high zoom (too close), set a specific zoom.
                if (leafletMarkers.length === 1) {
                    leafletMap.setZoom(13); // Zoom level for a single marker
                } else if (leafletMap.getZoom() > 15) { // Don't zoom in too extremely if markers are very close
                    leafletMap.setZoom(15);
                }
                // Optional: If markers are very far apart, fitBounds might zoom out too much.
                // You could enforce a minimum zoom level, but this might cut off some markers.
                // else if (leafletMap.getZoom() < 5) {
                //     leafletMap.setZoom(5);
                // }
            } else if (leafletMarkers.length === 1 && leafletMarkers[0].getLatLng()) {
                // Fallback if bounds somehow invalid but one marker exists
                leafletMap.setView(leafletMarkers[0].getLatLng(), 13);
            } else {
                console.warn("Map bounds invalid or no markers to fit. Map view may not be optimal.");
            }
        }


        async function showMapWithLeafletPins() {
            if (typeof L === 'undefined') {
                displayStatus("Map library (Leaflet) not ready. Please wait or refresh.", true, false);
                return;
            }
            const mapElement = document.getElementById('mapCanvasLeaflet');
            if (!mapElement) { console.error("mapCanvasLeaflet element not found!"); return; }
            
            // Clear previous markers from the map and the array
            if (leafletMarkers.length > 0) {
                leafletMarkers.forEach(marker => marker.remove());
                leafletMarkers = [];
            }

            if (!leafletMap) { // Initialize map only once, or re-initialize if needed
                let mapCenter = [34.730369, -86.586105]; // Default: Huntsville, AL
                leafletMap = L.map(mapElement).setView(mapCenter, 6); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18,
                }).addTo(leafletMap);
            } else {
                // If map exists, ensure it's cleared of old layers if you're not using featureGroup for everything
            }


            if (!allChurchesData || allChurchesData.length === 0) {
                displayStatus("No church data to display on map.", true, false);
                $('#mapModalLeaflet').modal('show'); 
                mapElement.innerHTML = "<p class='text-center p-5'>No church locations to display.</p>";
                return;
            }
            
            let geocodePromises = [];
            // leafletMarkers array is already cleared above

            allChurchesData.forEach(church => {
                if (!church) return;
                const churchName = church.ChurchName || "Church";
                const churchAddress = church.Address || "";
                const popupContent = `<strong>${churchName}</strong><br>${churchAddress}`;

                if (church.Latitude && church.Longitude && 
                    !isNaN(parseFloat(church.Latitude)) && !isNaN(parseFloat(church.Longitude))) {
                    
                    const lng = parseFloat(church.Latitude);
                    const lat = parseFloat(church.Longitude);
                    // console.log(`Using direct Lat/Lng for ${churchName}: Lat: ${lat}, Lng: ${lng}`);
                    const marker = L.marker([lat, lng]).bindPopup(popupContent);
                    leafletMarkers.push(marker); // Add to global array for later use by fitMapToMarkers
                } else if (churchAddress && String(churchAddress).trim() !== "") { 
                    geocodePromises.push(
                        geocodeAddressWithNominatim(churchAddress).then(coords => {
                            if (coords && !isNaN(coords.lat) && !isNaN(coords.lng)) { 
                                // console.log(`Geocoded ${churchName} (${churchAddress}): [${coords.lat}, ${coords.lng}]`);
                                const marker = L.marker([coords.lat, coords.lng]).bindPopup(popupContent); 
                                leafletMarkers.push(marker);
                            } else {
                                // console.log(`Geocoding returned null for ${churchName} (${churchAddress})`);
                            }
                        })
                    );
                }
            });

            function displayAndFitMap() {
                if (leafletMarkers.length > 0) {
                    leafletMarkers.forEach(marker => marker.addTo(leafletMap));
                    fitMapToMarkers(); // Use the new helper function
                } else {
                    mapElement.innerHTML = "<p class='text-center p-5'>No valid church locations could be mapped.</p>";
                    displayStatus("No locations could be mapped.", true, false);
                     // Optionally reset to default view if no markers
                    leafletMap.setView([34.730369, -86.586105], 6);
                }
                leafletMap.invalidateSize(); // Call after markers are added AND modal is visible
            }

            $('#mapModalLeaflet').modal('show'); // Show modal first

            // Handle map rendering after modal is fully shown and geocoding (if any) is done
            $('#mapModalLeaflet').off('shown.bs.modal').on('shown.bs.modal', function () { 
                if (leafletMap) leafletMap.invalidateSize(); // Invalidate size immediately when modal is shown

                if (geocodePromises.length > 0) {
                    displayStatus("Geocoding addresses... this may take a moment.", false, false);
                    Promise.allSettled(geocodePromises)
                        .then(() => {
                            displayAndFitMap();
                        });
                } else {
                    displayAndFitMap(); // No geocoding, just display and fit
                }
            });
        }

        document.getElementById("showChurchesMapBtnLeaflet").addEventListener("click", showMapWithLeafletPins);
        async function loadInitialData() {
            displayStatus("Loading data...", false, false); 
            try {
                const [churches, ministers, services] = await Promise.all([
                    fetchSheetDataForStaticPage("Churches"),
                    fetchSheetDataForStaticPage("Ministers"),
                    fetchSheetDataForStaticPage("Services") 
                ]);
                allChurchesData = churches || [];
                allMinistersData = ministers || [];
                allServicesData = services || [];
                populateChurchesTable();
                displayStatus("Data loaded successfully!", false, true);
            } catch (err) {
                console.error("General error during loadInitialData:", err);
                displayStatus("A general error occurred while loading data.", true, false);
                const tbody = document.getElementById("churchesTableBody");
                if(tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center">Error loading data.</td></tr>`;
            }
        }

        window.onload = function() {
            if(typeof $ !== 'undefined' && $.fn.DataTable && typeof L !== 'undefined') {
                loadInitialData();
            } else { 
                let missing = [];
                if(typeof $ === 'undefined') missing.push("jQuery");
                if(typeof $.fn.DataTable === 'undefined') missing.push("DataTables");
                if(typeof L === 'undefined') missing.push("Leaflet");
                const errorMsg = `Error: Required page components (${missing.join(', ')}) not loaded. Check script tags.`;
                console.error(errorMsg);
                displayStatus(errorMsg, true, false);
            }
        };
    </script>
</body>
</html>
