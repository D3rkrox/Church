<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Sermons</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 900px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .minister-section { margin-bottom: 30px; }
        .minister-name { border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.75rem; color: #0d6efd; }
        .sermon-item { padding: 15px; border: 1px solid #e9ecef; border-radius: 5px; margin-bottom: 15px; }
        .sermon-title { font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; }
        .sermon-player-container { min-height: 54px; }
        audio { width: 100%; margin-top: 10px; }
        #loadingIndicator { text-align: center; padding: 20px; font-size: 1.2em; }
        .back-link { margin-bottom: 20px; display: inline-block; }
    </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Church App</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto" id="dynamicNavLinks">
                </ul>
        </div>
    </div>
</nav>
    <div class="container">
        <header class="text-center mb-4">
            <h1>Audio Sermons</h1>
            <a href="<?= ScriptApp.getService().getUrl() ?>" class="back-link mt-2">‚Üê Back to Main Calendar</a>
        </header>

        <div id="sermonsContainer">
            <p id="loadingIndicator">Loading sermon list...</p>
        </div>
    </div>

    <script>
    // Define the URL to your Apps Script API
    const SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE/exec';

    function initialLoad() {
        populateNavbar();
        fetchSermonList();
    }

    async function populateNavbar() {
        // This function is identical to the one in app.js
        try {
            const response = await fetch(`${SCRIPT_URL}?action=getNav`);
            const result = await response.json();
            if (result.error) throw new Error(result.error);
            const links = result.data;
            const navLinksContainer = document.getElementById('dynamicNavLinks');
            if (!navLinksContainer || !links) return;
            links.forEach(link => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                const a = document.createElement('a');
                a.className = 'nav-link';
                a.href = link.url;
                a.textContent = link.title;
                if (!link.url.startsWith('https://d3rkrox.github.io')) { a.target = '_blank'; }
                li.appendChild(a);
                navLinksContainer.appendChild(li);
            });
        } catch (e) { console.error("Could not populate navbar:", e); }
    }

    async function fetchSermonList() {
        const sermonsContainer = document.getElementById('sermonsContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        try {
            const response = await fetch(`${SCRIPT_URL}?action=getSermons`);
            const result = await response.json();
            if(result.error) throw new Error(result.error);

            displaySermonList(result.data);

        } catch (error) {
            handleError(error);
        }
    }

    function displaySermonList(sermonDataByMinister) {
        // This function's content remains the same as before
        const sermonsContainer = document.getElementById('sermonsContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'none';
        sermonsContainer.innerHTML = '';
        if (!sermonDataByMinister || sermonDataByMinister.length === 0) {
            sermonsContainer.innerHTML = '<p class="text-center">No sermons found.</p>';
            return;
        }
        sermonDataByMinister.forEach(ministerData => {
            // ... (The rest of this function is identical to the previous version) ...
            const ministerSection = document.createElement('div');
            ministerSection.className = 'minister-section';
            ministerSection.innerHTML = `<h2 class="minister-name">${ministerData.ministerName}</h2>`;
            ministerData.sermons.forEach(sermon => {
                const sermonItemDiv = document.createElement('div');
                sermonItemDiv.className = 'sermon-item';
                const playerContainerId = `player-container-${sermon.fileId}`;
                sermonItemDiv.innerHTML = `<p class="sermon-title">${sermon.title}</p><div class="sermon-player-container d-flex align-items-center" id="${playerContainerId}"><button class="btn btn-primary" onclick="loadSermon('${sermon.fileId}')">Play Sermon</button><a href="https://drive.google.com/uc?export=download&id=${sermon.fileId}" class="btn btn-secondary ms-2" target="_blank" download="${sermon.title}.mp3">Download</a></div>`;
                ministerSection.appendChild(sermonItemDiv);
            });
            sermonsContainer.appendChild(ministerSection);
        });
    }
    
    async function loadSermon(fileId) {
        const playerContainer = document.getElementById(`player-container-${fileId}`);
        if (!playerContainer) return;
        playerContainer.innerHTML = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>`;

        try {
            const response = await fetch(`${SCRIPT_URL}?action=getSermonBase64&fileId=${fileId}`);
            const result = await response.json();
            if(result.error) throw new Error(result.error);
            const sermonObject = result.data;
            const dataUrl = `data:${sermonObject.mimeType};base64,${sermonObject.data}`;
            const audioControl = document.createElement('audio');
            audioControl.setAttribute('controls', '');
            audioControl.setAttribute('autoplay', '');
            audioControl.innerHTML = `<source src="${dataUrl}" type="${sermonObject.mimeType}">Your browser does not support the audio element.`;
            playerContainer.innerHTML = '';
            playerContainer.appendChild(audioControl);
        } catch(error) {
            handleError(error, `player-container-${fileId}`);
        }
    }

    function handleError(error, containerId) {
        // This function remains the same as before
        let errorContainer = containerId ? document.getElementById(containerId) : document.getElementById('sermonsContainer');
        if (errorContainer) { errorContainer.innerHTML = `<p class="text-danger">Error: ${error.message || error}.</p>`; }
        console.error('Error:', error);
    }

    window.addEventListener('load', initialLoad);
</script>
</body>
</html>